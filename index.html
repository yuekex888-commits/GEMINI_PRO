<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>AI Chat Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            /* 适配 iOS 安全区域 */
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: calc(50px + var(--safe-top));
            --gemini-blue: #1a73e8;
            --gemini-bg: #ffffff;
            --gemini-surface: #f8f9fa;
        }

        body {
            background-color: var(--gemini-bg);
            font-family: "Google Sans", Roboto, -apple-system, BlinkMacSystemFont, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #202124;
            user-select: none; /* 防止长按选中文本干扰操作 */
        }

        /* 允许消息区域选择文本 */
        #messages, #user-input {
            user-select: text; 
        }

        /* 侧边栏动画 */
        .sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            background-color: var(--gemini-surface);
        }

        /* 聊天区域 */
        #chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--gemini-bg);
        }

        /* 顶部导航 */
        header {
            height: var(--header-height);
            padding-top: var(--safe-top);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            z-index: 50;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
        }

        /* 消息列表区域 */
        #messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-top: var(--header-height);
            padding-bottom: calc(90px + var(--safe-bottom));
            scroll-behavior: smooth;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        /* 底部输入框 */
        #input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: transparent;
            padding: 10px 16px;
            padding-bottom: max(10px, var(--safe-bottom));
            z-index: 50;
            pointer-events: none;
        }

        /* 输入胶囊容器 */
        .input-capsule {
            background: var(--gemini-surface);
            border-radius: 2rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.05);
            padding: 8px;
            pointer-events: auto;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .input-capsule:focus-within {
             border-color: var(--gemini-blue);
             box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
        }

        /* 消息气泡 */
        .message-container {
            display: flex;
            margin-bottom: 1.5rem;
            animation: fadeIn 0.3s ease;
        }

        .message.user {
            margin-left: auto;
            background-color: var(--gemini-blue);
            color: white;
            border-radius: 1.25rem 1.25rem 0.25rem 1.25rem;
            padding: 12px 18px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            max-width: 85%;
        }

        .message.assistant {
            margin-right: auto;
            background-color: transparent;
            color: #202124;
            padding: 0;
            max-width: 100%;
            width: 100%;
        }
        
        .assistant-icon {
            width: 28px;
            height: 28px;
            margin-right: 12px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sparkle-icon {
            color: var(--gemini-blue);
            font-size: 1.2rem;
        }

        .message img {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 8px;
            border: 1px solid #f1f3f4;
        }
        
        /* Markdown 样式 */
        .prose { font-size: 1rem; line-height: 1.6; }
        .prose p { margin-bottom: 1em; }
        .prose p:last-child { margin-bottom: 0; }
        .prose pre { background: #f1f3f4; color: #202124; padding: 16px; border-radius: 12px; overflow-x: auto; margin: 1em 0; border: 1px solid #e0e0e0;}
        .prose code { font-family: "Roboto Mono", monospace; background-color: #f1f3f4; padding: 2px 6px; border-radius: 6px; font-size: 0.9em; }
        .prose ul, .prose ol { margin-left: 1.5em; margin-bottom: 1em; }
        .prose li { margin-bottom: 0.5em; }
        .prose h1, .prose h2, .prose h3 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 600; color: #202124; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 录音浮层 (WeChat Style) */
        #recording-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            z-index: 100;
            color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        #recording-overlay.active {
            opacity: 1;
        }
        .recording-wave {
            display: flex;
            gap: 4px;
            height: 30px;
            align-items: center;
            margin-bottom: 15px;
        }
        .recording-wave div {
            width: 4px;
            background: #fff;
            animation: wave 0.5s infinite ease-in-out;
            border-radius: 2px;
        }
        .recording-wave div:nth-child(2) { animation-delay: 0.1s; }
        .recording-wave div:nth-child(3) { animation-delay: 0.2s; }
        .recording-wave div:nth-child(4) { animation-delay: 0.3s; }
        .recording-wave div:nth-child(5) { animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { height: 10px; }
            50% { height: 30px; }
        }

        /* 按钮按下效果 */
        #voice-btn:active {
            background-color: #e5e7eb;
            color: var(--gemini-blue);
            transform: scale(0.95);
        }

        /* 设置弹窗动画 */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }

        /* 思考过程折叠样式 */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body>

    <!-- 侧边栏遮罩 -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden transition-opacity backdrop-blur-sm" onclick="toggleSidebar()"></div>

    <!-- 录音状态浮层 (微信风格) -->
    <div id="recording-overlay">
        <div class="recording-wave">
            <div></div><div></div><div></div><div></div><div></div>
        </div>
        <p class="text-sm font-medium">正在说话...</p>
    </div>

    <!-- 侧边栏 (历史记录) -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 w-72 h-full border-r border-gray-100 z-50 transform -translate-x-full flex flex-col shadow-xl">
        <div class="p-4 flex justify-between items-center bg-transparent shrink-0">
            <h2 class="font-bold text-xl text-gray-800" style="font-family: 'Google Sans', sans-serif;">AI Chat Pro</h2>
        </div>
        
        <!-- 列表区域 -->
        <div id="chat-list" class="flex-1 overflow-y-auto p-3 space-y-2">
            <!-- 列表由 JS 生成，首项将是新建对话 -->
        </div>

        <!-- 底部设置按钮区域 -->
        <div class="p-4 border-t border-gray-100 bg-gray-50 shrink-0">
            <button onclick="openSettings()" class="w-full flex items-center justify-center py-3 px-4 text-gray-600 hover:text-blue-600 hover:bg-white rounded-xl transition-all border border-transparent hover:border-gray-200 hover:shadow-sm text-sm font-medium">
                <i class="fas fa-cog mr-2"></i> 设置 API & 模型
            </button>
        </div>
    </div>

    <!-- 设置弹窗 Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 relative z-10 transform transition-all scale-100 opacity-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">设置</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL</label>
                    <input type="text" id="setting-url" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50" placeholder="https://api.grsai.com/v1/chat/completions">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="password" id="setting-key" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50" placeholder="sk-...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">模型名称 (Model)</label>
                    <input type="text" id="setting-model" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50" placeholder="gemini-3-pro">
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="resetSettings()" class="flex-1 px-4 py-3 text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl text-sm font-medium transition-colors">
                    恢复默认
                </button>
                <button onclick="saveSettings()" class="flex-1 px-4 py-3 text-white bg-blue-600 hover:bg-blue-700 rounded-xl text-sm font-medium transition-colors shadow-sm">
                    保存
                </button>
            </div>
        </div>
    </div>

    <!-- 主聊天界面 -->
    <div id="chat-container" class="relative w-full">
        <!-- 顶部 -->
        <header class="px-5">
            <button onclick="toggleSidebar()" class="p-3 -ml-3 text-gray-600 hover:bg-gray-100 rounded-full transition-colors active:scale-95">
                <i class="fas fa-bars text-xl"></i>
            </button>
            
            <!-- 标题 (点击重命名) -->
            <div class="flex-1 mx-2 overflow-hidden flex justify-center cursor-pointer hover:bg-gray-50 py-2 rounded-lg transition-colors group" onclick="renameCurrentChat()" title="点击重命名">
                 <h1 class="font-medium text-lg truncate text-gray-700 max-w-[200px]" id="current-chat-title">新对话</h1>
                 <i class="fas fa-pen text-xs text-gray-400 ml-2 mt-1.5 opacity-0 group-hover:opacity-100"></i>
            </div>
            
            <!-- 设置按钮 -->
            <button onclick="openSettings()" class="p-3 -mr-3 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors active:scale-95">
                <i class="fas fa-cog"></i>
            </button>
        </header>

        <!-- 消息流 -->
        <div id="messages" class="px-4 relative">
            <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 p-8 transition-opacity duration-300" id="empty-state">
                 <div class="w-20 h-20 bg-gradient-to-tr from-blue-100 to-purple-100 rounded-3xl flex items-center justify-center mb-6 shadow-sm">
                    <i class="fas fa-sparkles text-4xl text-blue-500 opacity-80"></i>
                </div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-3">你好，我是 AI 助手</h2>
                <p class="text-gray-500 text-center max-w-sm">发图片、发语音，开始对话吧。</p>
            </div>
        </div>

        <!-- 底部输入栏 -->
        <div id="input-area">
            <!-- 图片预览区域 -->
            <div id="image-preview-container" class="hidden mb-3 relative inline-block ml-4">
                <img id="image-preview" src="" class="h-20 w-20 object-cover rounded-xl border border-gray-200 shadow-sm">
                <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-gray-800 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md hover:bg-gray-900 active:scale-90 transition-transform">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="input-capsule flex items-end gap-1 mx-2 sm:mx-auto sm:max-w-3xl bg-white">
                <!-- 图片上传按钮 -->
                <button onclick="document.getElementById('image-upload').click()" class="p-3 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors shrink-0 active:scale-95">
                    <i class="far fa-image text-xl"></i>
                </button>
                <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageUpload(this)">

                <!-- 文本输入 -->
                <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-0 focus:ring-0 px-2 py-3 text-base resize-none max-h-32 text-gray-700 placeholder-gray-400" placeholder="输入消息..." oninput="autoResize(this)"></textarea>

                <!-- 语音按钮 (微信式按住说话) -->
                <!-- 使用 touchstart/touchend 适配手机，mousedown/mouseup 适配电脑 -->
                <button id="voice-btn" 
                    ontouchstart="handleVoiceStart(event)" 
                    ontouchend="handleVoiceEnd(event)" 
                    onmousedown="handleVoiceStart(event)" 
                    onmouseup="handleVoiceEnd(event)" 
                    class="p-3 text-gray-500 hover:text-blue-600 hover:bg-blue-50 transition-colors shrink-0 rounded-full select-none -webkit-user-select-none">
                    <i class="fas fa-microphone text-xl"></i>
                </button>

                <!-- 发送按钮 -->
                <button id="send-btn" onclick="sendMessage()" class="p-3 text-gray-300 rounded-full transition-all shrink-0 cursor-not-allowed flex items-center justify-center w-12 h-12" disabled>
                    <i class="fas fa-paper-plane text-xl" id="send-icon"></i>
                    <i class="fas fa-spinner fa-spin text-xl hidden" id="loading-icon"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 默认配置 ---
        const DEFAULT_CONFIG = {
            apiKey: 'sk-28c0d0093c2c4486ac3b394da91f7386',
            baseUrl: 'https://api.grsai.com/v1/chat/completions',
            model: 'gemini-3-pro'
        };

        // --- 状态管理 ---
        let conversations = JSON.parse(localStorage.getItem('ai_conversations')) || [];
        let currentChatId = localStorage.getItem('current_chat_id');
        let currentImageBase64 = null;
        let recognition = null;
        let isRecording = false;

        // 获取当前 API 配置
        function getApiConfig() {
            const stored = JSON.parse(localStorage.getItem('ai_api_config'));
            return { ...DEFAULT_CONFIG, ...stored };
        }

        // 初始化
        if (conversations.length === 0) {
            createNewChat(false);
        } else if (!currentChatId || !conversations.find(c => c.id === currentChatId)) {
            currentChatId = conversations[0].id;
        }
        
        loadChatList();
        loadCurrentChat();
        updateSendButtonState();

        // --- 设置逻辑 ---
        function openSettings() {
            const config = getApiConfig();
            document.getElementById('setting-url').value = config.baseUrl;
            document.getElementById('setting-key').value = config.apiKey;
            document.getElementById('setting-model').value = config.model;
            document.getElementById('settings-modal').classList.remove('hidden');
            toggleSidebar(false);
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const newConfig = {
                baseUrl: document.getElementById('setting-url').value.trim(),
                apiKey: document.getElementById('setting-key').value.trim(),
                model: document.getElementById('setting-model').value.trim()
            };
            if(!newConfig.baseUrl || !newConfig.apiKey || !newConfig.model) {
                alert("所有字段都不能为空");
                return;
            }
            localStorage.setItem('ai_api_config', JSON.stringify(newConfig));
            closeSettings();
            alert("设置已保存！");
        }

        function resetSettings() {
            if(confirm("确定要恢复默认设置吗？")) {
                document.getElementById('setting-url').value = DEFAULT_CONFIG.baseUrl;
                document.getElementById('setting-key').value = DEFAULT_CONFIG.apiKey;
                document.getElementById('setting-model').value = DEFAULT_CONFIG.model;
            }
        }

        // --- 聊天列表管理 ---

        function renameCurrentChat() {
            const chat = getCurrentChat();
            if(!chat) return;
            renameChat(chat.id, chat.title);
        }

        function renameChat(id, currentTitle) {
            if(window.event) window.event.stopPropagation();
            const newTitle = prompt("重命名对话:", currentTitle);
            if (newTitle && newTitle.trim() !== "") {
                const chat = conversations.find(c => c.id === id);
                if (chat) {
                    chat.title = newTitle.trim();
                    saveData();
                    loadChatList();
                    if (id === currentChatId) {
                        document.getElementById('current-chat-title').innerText = chat.title;
                    }
                }
            }
        }
        
        function deleteChat(id, event) {
            if(event) event.stopPropagation();
            if(confirm('确定要删除这个对话吗？')) {
                const isCurrent = id === currentChatId;
                conversations = conversations.filter(c => c.id !== id);
                if (conversations.length === 0) {
                    createNewChat();
                } else {
                    if (isCurrent) currentChatId = conversations[0].id;
                    saveData();
                    loadChatList();
                    if (isCurrent) loadCurrentChat();
                }
            }
        }

        // --- 语音识别 (WeChat Style) ---
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; 
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById('user-input');
                // 追加文本
                input.value += (input.value ? ' ' : '') + transcript;
                autoResize(input);
                updateSendButtonState();
            };

            recognition.onerror = (event) => {
                console.error('语音识别错误:', event.error);
                document.getElementById('recording-overlay').classList.remove('active');
            };

            recognition.onend = () => {
                document.getElementById('recording-overlay').classList.remove('active');
                isRecording = false;
            };
        } else {
            document.getElementById('voice-btn').style.display = 'none';
        }

        function handleVoiceStart(e) {
            e.preventDefault(); // 防止触发其他点击事件或滚动
            if (recognition && !isRecording) {
                try {
                    recognition.start();
                    isRecording = true;
                    document.getElementById('recording-overlay').classList.add('active');
                    if (navigator.vibrate) navigator.vibrate(50);
                } catch (e) { console.error(e); }
            }
        }

        function handleVoiceEnd(e) {
            e.preventDefault();
            if (recognition && isRecording) {
                recognition.stop();
                // Overlay 的移除由 onend 处理
            }
        }

        // --- 聊天核心逻辑 ---

        function createNewChat(refresh = true) {
            const newChat = {
                id: Date.now().toString(),
                title: '新对话',
                messages: []
            };
            conversations.unshift(newChat);
            currentChatId = newChat.id;
            saveData();
            if (refresh) {
                loadChatList();
                loadCurrentChat();
                toggleSidebar(false);
            }
        }

        function switchChat(id) {
            currentChatId = id;
            localStorage.setItem('current_chat_id', id);
            loadCurrentChat();
            loadChatList();
            toggleSidebar(false);
        }

        function saveData() {
            localStorage.setItem('ai_conversations', JSON.stringify(conversations));
            localStorage.setItem('current_chat_id', currentChatId);
        }

        function getCurrentChat() {
            return conversations.find(c => c.id === currentChatId);
        }

        // 侧边栏渲染：新对话按钮在第一位
        function loadChatList() {
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            
            // 1. 添加“新建对话”按钮作为列表第一项
            const newChatBtn = document.createElement('button');
            newChatBtn.onclick = () => createNewChat();
            newChatBtn.className = "w-full mb-3 p-3 rounded-2xl bg-blue-50 text-blue-600 font-medium flex items-center justify-center hover:bg-blue-100 transition-colors";
            newChatBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> 新建对话';
            list.appendChild(newChatBtn);

            // 2. 渲染历史列表
            conversations.forEach(chat => {
                const div = document.createElement('div');
                const isActive = chat.id === currentChatId;
                div.className = `p-3 rounded-2xl cursor-pointer flex items-center justify-between group transition-all mb-1 ${isActive ? 'bg-[#e8f0fe] text-[#1a73e8] font-medium' : 'hover:bg-gray-100 text-gray-700'}`;
                
                div.innerHTML = `
                    <div class="flex items-center flex-1 overflow-hidden h-full py-1" onclick="switchChat('${chat.id}')">
                        <i class="far fa-comment-alt mr-3 opacity-70 ${isActive ? 'text-blue-500' : ''} shrink-0"></i>
                        <span class="truncate text-sm w-full">${escapeHtml(chat.title)}</span>
                    </div>
                    <div class="flex items-center gap-1 ${isActive ? 'opacity-100' : 'opacity-0'} group-hover:opacity-100 transition-opacity">
                        <button onclick="renameChat('${chat.id}', '${escapeHtml(chat.title)}')" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-blue-600 rounded-full hover:bg-white transition-colors">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                         <button onclick="deleteChat('${chat.id}', event)" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-red-600 rounded-full hover:bg-white transition-colors">
                            <i class="far fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function loadCurrentChat() {
            const chat = getCurrentChat();
            if (!chat) return;

            document.getElementById('current-chat-title').innerText = chat.title;
            const messagesDiv = document.getElementById('messages');
            
            // 保留 empty-state 元素
            const emptyState = document.getElementById('empty-state');
            while(messagesDiv.lastElementChild && messagesDiv.lastElementChild.id !== 'empty-state') {
                messagesDiv.removeChild(messagesDiv.lastElementChild);
            }

            if (chat.messages.length === 0) {
                emptyState.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                emptyState.classList.add('opacity-0', 'pointer-events-none');
                chat.messages.forEach(msg => renderMessage(msg));
                scrollToBottom();
            }
            updateSendButtonState();
        }

        // 解析 <think> 标签和 Markdown
        function formatMessageContent(content) {
            const thinkRegex = /<think>([\s\S]*?)<\/think>/g;
            if (!thinkRegex.test(content)) return marked.parse(content);
            
            thinkRegex.lastIndex = 0;
            let formattedHtml = '';
            let lastIndex = 0;
            let match;
            
            while ((match = thinkRegex.exec(content)) !== null) {
                const before = content.substring(lastIndex, match.index);
                if (before.trim()) formattedHtml += marked.parse(before);
                
                const thinkHtml = marked.parse(match[1]);
                formattedHtml += `
                    <details class="group mb-4 rounded-xl bg-[#f0f4f9] border-none overflow-hidden">
                        <summary class="flex items-center gap-2 px-4 py-3 cursor-pointer select-none text-sm font-medium text-gray-600 hover:bg-[#e9eef6] transition-colors">
                            <i class="fas fa-brain text-[#1a73e8]"></i>
                            <span>思考过程</span>
                            <i class="fas fa-chevron-down ml-auto text-xs text-gray-500 transition-transform duration-200 group-open:rotate-180"></i>
                        </summary>
                        <div class="px-4 py-3 text-sm text-gray-600 bg-[#f0f4f9] border-t border-gray-200/50 prose prose-sm max-w-none prose-p:my-1">
                            ${thinkHtml}
                        </div>
                    </details>
                `;
                lastIndex = thinkRegex.lastIndex;
            }
            
            const after = content.substring(lastIndex);
            if (after.trim()) formattedHtml += marked.parse(after);
            
            return formattedHtml;
        }

        function renderMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const container = document.createElement('div');
            container.className = `message-container w-full ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            if (msg.role === 'user') {
                container.innerHTML = `
                    <div class="message user text-[15px] leading-relaxed shadow-sm">
                        ${msg.image ? `<img src="${msg.image}" class="max-h-60 block mb-3 rounded-lg border border-white/20">` : ''}
                        ${msg.content ? `<div class="whitespace-pre-wrap">${escapeHtml(msg.content)}</div>` : ''}
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="assistant-icon pt-1">
                         <i class="fas fa-sparkles sparkle-icon"></i>
                    </div>
                    <div class="message assistant prose prose-slate max-w-none">
                        ${formatMessageContent(msg.content)}
                    </div>
                `;
            }
            messagesDiv.appendChild(container);
            document.getElementById('empty-state').classList.add('opacity-0', 'pointer-events-none');
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const sendIcon = document.getElementById('send-icon');
            const loadingIcon = document.getElementById('loading-icon');

            const text = input.value.trim();
            const image = currentImageBase64;

            if ((!text && !image) || sendBtn.disabled) return;

            // 1. 设置发送中状态 (防止重复点击，显示 Loading)
            sendBtn.disabled = true;
            sendIcon.classList.add('hidden');
            loadingIcon.classList.remove('hidden');

            const config = getApiConfig();
            const chat = getCurrentChat();
            const userMsg = { role: 'user', content: text, image: image };

            // 2. 更新 UI
            chat.messages.push(userMsg);
            
            if (chat.messages.length === 1) {
                chat.title = text.substring(0, 15) || '图片对话';
                loadChatList();
                document.getElementById('current-chat-title').innerText = chat.title;
            }

            saveData();
            renderMessage(userMsg);
            
            // 3. 清空输入
            input.value = '';
            input.style.height = 'auto';
            clearImage(); // 关键：发送后立刻清除图片缓存
            scrollToBottom();
            // 保持按钮 Loading 状态直到 API 返回

            // 4. 构建 Payload
            const apiMessages = chat.messages.map(m => {
                if (m.role === 'user') {
                    if (m.image) {
                        return {
                            role: 'user',
                            content: [
                                // OpenAI 兼容接口通常要求 text 字段不能为空，给一个默认提示
                                { type: "text", text: m.content || "Analyze this image" },
                                { type: "image_url", image_url: { url: m.image } }
                            ]
                        };
                    } else {
                        return { role: 'user', content: m.content };
                    }
                } else {
                    return { role: 'assistant', content: m.content };
                }
            });

            // 5. 显示 AI 思考中占位符
            const loadingId = 'loading-' + Date.now();
            const loadingContainer = document.createElement('div');
            loadingContainer.id = loadingId;
            loadingContainer.className = 'message-container w-full justify-start';
            loadingContainer.innerHTML = `
                 <div class="assistant-icon pt-1">
                     <i class="fas fa-sparkles sparkle-icon opacity-50"></i>
                </div>
                <div class="message assistant flex items-center text-gray-500">
                    <span class="flex space-x-1">
                        <span class="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                        <span class="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-2 h-2 bg-gray-300 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                    </span>
                </div>`;
            document.getElementById('messages').appendChild(loadingContainer);
            scrollToBottom();

            try {
                const response = await fetch(config.baseUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${config.apiKey}` },
                    body: JSON.stringify({ model: config.model, messages: apiMessages, stream: false })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                if (data.error) throw new Error(data.error.message);

                const aiContent = data.choices[0].message.content;
                const aiMsg = { role: 'assistant', content: aiContent };
                
                chat.messages.push(aiMsg);
                saveData();
                renderMessage(aiMsg);
                scrollToBottom();

            } catch (error) {
                document.getElementById(loadingId)?.remove();
                renderMessage({ role: 'assistant', content: `**出错了**：${error.message} \n\n请检查网络或 API 设置。如果是发送图片，可能是图片太大超过了模型限制。` });
                scrollToBottom();
            } finally {
                // 6. 恢复发送按钮状态
                sendIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
                updateSendButtonState();
            }
        }

        // --- 工具函数 ---

        function handleImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageBase64 = e.target.result;
                document.getElementById('image-preview').src = currentImageBase64;
                document.getElementById('image-preview-container').classList.remove('hidden');
                updateSendButtonState();
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            currentImageBase64 = null;
            document.getElementById('image-upload').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
            updateSendButtonState();
        }

        function toggleSidebar(forceOpen = null) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            const shouldOpen = forceOpen !== null ? forceOpen : !isOpen;
            sidebar.classList.toggle('-translate-x-full', !shouldOpen);
            overlay.classList.toggle('hidden', !shouldOpen);
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
            updateSendButtonState();
        }

        function updateSendButtonState() {
            const input = document.getElementById('user-input');
            const hasText = input.value.trim().length > 0;
            const hasImage = currentImageBase64 !== null;
            const sendBtn = document.getElementById('send-btn');
            
            // 如果正在 loading (按钮被 disable 且 loading icon 显示)，则不应该在这里被重置
            const isLoading = !document.getElementById('loading-icon').classList.contains('hidden');
            if (isLoading) return;

            if (hasText || hasImage) {
                sendBtn.classList.remove('text-gray-300', 'cursor-not-allowed');
                sendBtn.classList.add('text-blue-600', 'bg-blue-50', 'active:scale-95');
                sendBtn.disabled = false;
            } else {
                sendBtn.classList.add('text-gray-300', 'cursor-not-allowed');
                sendBtn.classList.remove('text-blue-600', 'bg-blue-50', 'active:scale-95');
                sendBtn.disabled = true;
            }
        }

        function scrollToBottom() {
            const messages = document.getElementById('messages');
            setTimeout(() => { messages.scrollTop = messages.scrollHeight; }, 100);
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        document.getElementById('user-input').addEventListener('input', updateSendButtonState);
    </script>
</body>
</html>
